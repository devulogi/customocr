@startuml Enhanced Document Processor Activity Diagram
!theme plain
skinparam activity {
    BackgroundColor lightblue
    BorderColor black
    FontSize 12
}
skinparam decision {
    BackgroundColor lightyellow
    BorderColor black
}

start

:PDF Input;

switch (Processing Mode?)
case (Single Page)
    :Process First Page Only\n(Fastest);
case (All Pages - Page-by-page)
    :Extract Each Page as Image\n(PyMuPDF);
case (All Pages - Built-in)
    :Built-in PDF Processing\n(PaddleOCR/PPStructureV3);
endswitch

partition "Dual Analysis" {
    fork
        :OCR Analysis\n(PaddleOCR)\n- Extract text\n- Get confidence scores\n- Detect bounding boxes;
    fork again
        :Structure Analysis\n(PPStructureV3)\n- Identify titles\n- Detect headers\n- Find paragraphs\n- Locate figures/tables;
    end fork
}

:Post-process OCR Text\n- Fix common errors\n- Correct spacing;

:Combine OCR & Structure\n- Match by bounding box overlap (50%)\n- Create unified elements;

:Build Hierarchical Structure\n- Sort by Y,X position\n- Assign hierarchy levels\n- Create parent-child relationships;

partition "Semantic Chunking" {
    :Process All Elements\n(No Quality Filtering);
    :Group Elements\n(150-400 tokens);
    :Create Coherent Content\n(Title - Subtitle: Content);
    :Generate Fragment ID\n(MD5 hash);
    :Build Metadata\n- Page, bbox, confidence\n- Section titles, hierarchy\n- Token count, element count;
}

:Save Chunks for Vectorization\n- JSON format\n- Ready for vector database;

:RAG-Ready Chunks;

stop

@enduml