@startuml Enhanced Document Processor Sequence Diagram
!theme plain
skinparam participant {
    BackgroundColor lightblue
    BorderColor black
}

participant "Client" as C
participant "DocumentProcessor" as DP
participant "PyMuPDF" as PDF
participant "PaddleOCR" as OCR
participant "PPStructureV3" as PS
participant "HierarchyBuilder" as HB
participant "ChunkGenerator" as CG
participant "ElasticsearchClient" as ES
participant "EmbeddingModel" as EM

C -> DP: process_document(pdf_path)
activate DP

alt Solution 1: Single Page
    DP -> OCR: predict(document)[0]
    DP -> PS: predict(document)[0]
else Solution 2: All Pages (Page-by-page)
    DP -> PDF: open(document)
    activate PDF
    PDF --> DP: page_count
    deactivate PDF
    
    loop for each page
        DP -> PDF: extract_page_as_image(page_num)
        activate PDF
        PDF --> DP: temp_image_file
        deactivate PDF
        
        par OCR Analysis
            DP -> OCR: predict(temp_image_file)
            activate OCR
            OCR --> DP: ocr_result\n{texts, scores, boxes}
            deactivate OCR
        else Structure Analysis
            DP -> PS: predict(temp_image_file)
            activate PS
            PS --> DP: structure_result\n{elements, labels, bboxes}
            deactivate PS
        end
        
        DP -> DP: post_process_ocr_text()
        DP -> DP: combine_ocr_and_structure()
        
        DP -> HB: build_hierarchical_structure(elements, page_num)
        activate HB
        HB -> HB: sort_by_position()
        HB -> HB: assign_hierarchy_levels()
        HB -> HB: create_parent_child_relationships()
        HB --> DP: hierarchy[]
        deactivate HB
        
        DP -> CG: create_semantic_chunks(hierarchy, page_num)
        activate CG
        note right: No quality filtering\n(process all elements)
        CG -> CG: group_elements(150-400 tokens)
        CG -> CG: create_coherent_content()
        CG -> CG: generate_fragment_id()
        CG -> CG: create_chunk_metadata()
        CG --> DP: chunks[]
        deactivate CG
        
        DP -> DP: cleanup_temp_file()
    end
else Solution 3: Built-in PDF Processing
    DP -> OCR: predict(document) [all pages]
    DP -> PS: predict(document) [all pages]
    
    loop for each page result
        DP -> DP: post_process_ocr_text()
        DP -> DP: combine_ocr_and_structure()
        DP -> HB: build_hierarchical_structure()
        DP -> CG: create_semantic_chunks()
    end
end

DP --> C: all_chunks[]
deactivate DP

note over C: Elasticsearch Integration Phase

C -> ES: bulk_create_chunks(chunks)
activate ES
ES --> C: upload_response
deactivate ES

C -> ES: get_chunks_without_vectors()
activate ES
ES --> C: chunks_without_embeddings[]
deactivate ES

loop for each chunk without vector
    C -> ES: get_chunk_content(fragment_id)
    activate ES
    ES --> C: content
    deactivate ES
    
    C -> EM: encode(content)
    activate EM
    EM --> C: embedding_vector
    deactivate EM
    
    C -> ES: add_vector_to_chunk(fragment_id, embedding)
    activate ES
    ES --> C: update_response
    deactivate ES
end

note over C: RAG-Ready Chunks Available

@enduml